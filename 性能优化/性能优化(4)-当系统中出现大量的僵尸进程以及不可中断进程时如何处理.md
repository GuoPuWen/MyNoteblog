之前说到过平均负载是指：

- 处于可运行状态或者等待CPU的进程是指R状态的进程
- 处于不可中断的进程是指D状态的进程

那么今天我们就来分析一下当系统有大量的处于不可中断状态的进程时应该怎么办？

# 进程状态

top和ps是最常用的查看进程状态的工具，其中有一个S列，表示了进程的状态

![image-20211209163537591](http://cdn.noteblogs.cn/image-20211209163537591.png)

- R：Running和Runnable的缩写，表示进程在CPU的就绪队列中，表示正在运行或者正在等待运行
- D：是Disk Sleep的缩写，表示不可中断状态睡眠，一般表示进程正在和硬件交互，并且交互过程不允许被其他进程或中断打断
- Z：是Zombie的缩写，表示僵尸进程，也就是进程实际上已经结束了，但是父进程还没有回收它的资源（比如进程的描述符、PID等）
- S：是Interruptible Sleep的缩写，也就是可中断状态睡眠，表示进程因为等待某个时间而被系统挂起，当进程等待的事件发生时，它会被唤醒并且进入R状态
- I：是Idle的缩写，也就是空闲状态，用在不可中断睡眠的内核线程上，需要注意的是对某些内核线程来说，实际上没有任何负载，所以D状态的进程会导致平均负载升高，但是I状态的进程却不会
- T：Stoopped或Traced的缩写，表示进程处于暂停或者跟踪状态
- X：Dead的缩写，表示进程已经消亡，也就是在top和ps命令中看不到

# 案列

下面运行一个基于Ubuntu 20.2版本的案列，模拟当系统出现大量的僵尸进程和不可中断进程，案例的github地址 https://github.com/feiskyer/linux-perf-examples/tree/master/high-iowait-process （需要提前安装好docker环境）

```shell
$ sudo docker run --privileged --name=app -itd feisky/app:iowait  
```

![image-20211213095244669](http://cdn.noteblogs.cn/image-20211213095244669.png)

使用top查看系统资源的使用情况，能发现一些问题：

- 系统的平均负载在过去的1分钟，5分钟和15分钟依次在升高，说明很可能系统遇到了性能瓶颈
- 在第二行任务一行，可以看到zombie的数量已经有了269个，并且在不断的升高，说明系统存在大量的僵尸的进程
- 第三行cpu的使用情况，cpu的使用率不是很高，但是iowaie的值已经到达了77.6，有点不太正常

通过以上的分析，大概可以得出以下两个结论：

1. iowait太高了，导致系统平均负载升高，并且已经达到了系统CPU的个数，2.20已经超过了系统cpu个数2
2. 僵尸进程在不断的增多，应该是应用程序没有正确的清理子进程

那么接下来就利用一些工具来分析系统的问题到底在哪里？

很显然，我们已知的情况是，系统的io在不断的升高，那么可以使用dstat工具查看系统的io情况